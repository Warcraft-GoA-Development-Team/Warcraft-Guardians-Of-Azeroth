namespace=WCUND
# Creates the Scourge
province_event = {
	id = WCUND.99

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		create_character = {
			name = Ner'zhul
			dynasty = 2353
			religion = death_god
			culture = scourge
			female = no
			age = 58
			attributes = {
				martial=5 diplomacy=6 stewardship=5 intrigue=5 learning=7
			}
			trait = mastermind_theologian
			trait = inspiring_leader
			trait = creature_lich
			trait = class_necromancer_9
			trait = being_undead
			trait = lich_king
			trait = in_ice_prison
			trait = shrewd trait = patient trait = ambitious trait = proud trait = deceitful trait = cruel
			flag = is_nerzhul
		}
		new_character = {
			save_event_target_as = target_lich_king
			# Used in scripted effects
			save_event_target_as = target_province_holder
			save_event_target_as = target_settler
			
			set_global_flag = lich_king_happened

			wealth = 1000
			prestige = 1000
			piety = 250
			set_graphical_culture = nerzhul
			add_artifact = scepter_of_sargeras
			
			c_icecrown = {
				location = { convert_to_target_undead_province_effect = yes }
				
				# event_target:target_settler and its people settle here
				settle_as_target_settler_effect = yes
			}
			d_icecrown = {
				any_direct_de_jure_vassal_title = {
					location = { convert_to_target_undead_province_effect = yes }
				
					# event_target:target_settler and its people settle here
					settle_as_target_settler_effect = yes
				}
			}
			d_skalmarnes = {
					any_direct_de_jure_vassal_title = {
						location = { convert_to_target_undead_province_effect = yes }
				
					# event_target:target_settler and its people settle here
					settle_as_target_settler_effect = yes
					}
				}
			d_silentreach = {
				any_direct_de_jure_vassal_title = {
						location = { convert_to_target_undead_province_effect = yes }
				
					# event_target:target_settler and its people settle here
					settle_as_target_settler_effect = yes
					}
				}
			d_dragonwastes = {
				any_direct_de_jure_vassal_title = {
						location = { convert_to_target_undead_province_effect = yes }
				
					# event_target:target_settler and its people settle here
					settle_as_target_settler_effect = yes
					}
				}
			d_snowdrift = {
				any_direct_de_jure_vassal_title = {
					location = { convert_to_target_undead_province_effect = yes }
				
					# event_target:target_settler and its people settle here
					settle_as_target_settler_effect = yes
				}
			}
			
			activate_title = { title = e_scourge status = yes }
			e_scourge = { gain_title = PREV }
			
			set_scourge_government_effect = yes
			
			spawn_scourge_troops_effect = yes
			spawn_scourge_troops_effect = yes
			spawn_scourge_troops_effect = yes
			spawn_scourge_troops_effect = yes

			c_icecrown = {
				# Declares war against player
				target_settler_declare_war_effect = yes
			}
			
			clear_settler_flag_effect = yes

			# Creates the dreadlords
			character_event = { id = WCUND.102 days = 7 }
		}
	}
}

# Creates the dreadlords, notificates the Lich King
character_event = {
	id = WCUND.102

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		# Creates Tichondrius
		create_character = {
			name = Tichondrius
			female = no
			dynasty = none
			culture = nathrezim religion = burning_legion_religion
			age = 500
			attributes = {
				martial=4 diplomacy=6 stewardship=5 intrigue=4 learning=8
			}
			trait = elusive_shadow
			trait = trickster
			trait = creature_nathrezim
			trait = class_warlock_8
			trait = being_demon
			trait = quick trait = patient trait = deceitful trait = gregarious trait = arbitrary trait = cruel trait = cynical
		}
		new_character = {
			e_scourge = {
				holder_scope = {
					PREVPREV = { move_character = PREV }
					opinion = { modifier = opinion_jailer who = PREVPREV }
				}
			}
		}
		# Creates Varimathras
		create_character = {
			name = Varimathras
			female = no
			dynasty = none
			culture = nathrezim religion = burning_legion_religion
			age = 500
			attributes = {
				martial=7 diplomacy=5 stewardship=5 intrigue=8 learning=8
			}
			trait = elusive_shadow
			trait = creature_nathrezim
			trait = class_warlock_6
			trait = being_demon
			trait = content trait = deceitful trait = proud trait = arbitrary trait = cruel trait = cynical trait = gregarious
		}
		new_character = {
			e_scourge = {
				holder_scope = {
					PREVPREV = { move_character = PREV }
					opinion = { modifier = opinion_jailer who = PREVPREV }
				}
			}
		}
		# Creates Mephistroth
		create_character = {
			name = Mephistroth
			female = no
			dynasty = none
			culture = nathrezim religion = burning_legion_religion
			age = 500
			attributes = {
				martial=7 diplomacy=8 stewardship=7 intrigue=5 learning=7
			}
			trait = elusive_shadow
			trait = creature_nathrezim
			trait = class_warlock_7
			trait = being_demon
			trait = wroth trait = deceitful trait = temperate trait = arbitrary trait = cruel trait = cynical trait = greedy
		}
		new_character = {
			e_scourge = {
				holder_scope = {
					PREVPREV = { move_character = PREV }
					opinion = { modifier = opinion_jailer who = PREVPREV }
				}
			}
		}
		# Creates Anetheron
		create_character = {
			name = Anetheron
			female = no
			dynasty = none
			culture = nathrezim religion = burning_legion_religion
			age = 500
			attributes = {
				martial=4 diplomacy=6 stewardship=4 intrigue=6 learning=5
			}
			trait = brilliant_strategist
			trait = creature_nathrezim
			trait = class_warlock_8
			trait = being_demon
			trait = wroth trait = deceitful trait = proud trait = arbitrary trait = cruel trait = cynical trait = diligent
		}
		new_character = {
			e_scourge = {
				holder_scope = {
					PREVPREV = { move_character = PREV }
					opinion = { modifier = opinion_jailer who = PREVPREV }
				}
			}
		}
		# Creates Balnazzar
		create_character = {
			name = Balnazzar
			female = no
			dynasty = none
			culture = nathrezim religion = burning_legion_religion
			age = 500
			attributes = {
				martial=7 diplomacy=4 stewardship=4 intrigue=5 learning=6
			}
			trait = elusive_shadow
			trait = creature_nathrezim
			trait = class_warlock_7
			trait = being_demon
			trait = shrewd trait = deceitful trait = proud trait = arbitrary trait = cruel trait = cynical trait = diligent trait = patient
		}
		new_character = {
			e_scourge = {
				holder_scope = {
					PREVPREV = { move_character = PREV }
					opinion = { modifier = opinion_jailer who = PREVPREV }
				}
			}
		}
		# Creates Detheroc
		create_character = {
			name = Detheroc
			female = no
			dynasty = none
			culture = nathrezim religion = burning_legion_religion
			age = 500
			attributes = {
				martial=6 diplomacy=7 stewardship=5 intrigue=5 learning=7
			}
			trait = fortune_builder
			trait = creature_nathrezim
			trait = class_warlock_5
			trait = being_demon
			trait = temperate trait = deceitful trait = proud trait = arbitrary trait = cruel trait = patient trait = humble
		}
		new_character = {
			e_scourge = {
				holder_scope = {
					PREVPREV = { move_character = PREV }
					opinion = { modifier = opinion_jailer who = PREVPREV }
				}
			}
		}
		
		if = {
			limit = {
				NOT = {
					has_game_rule = {
						name = legion_invasion
						value = off
					}
				}
			}
			set_global_flag = scourge_is_under_legion_control_flag
			character_event = { id = WCUND.109 days = 35 }		# Must be fired for Ner'zhul
		}
	}
}
# Warning about the timing of the Lich King/kills poor Ner'zhul
# Fires for Ner'zhul
character_event = {
	id = WCUND.109

	is_triggered_only = yes
	hide_window = yes
	
	ai = no				# AI has no timing
	only_playable = yes
	only_independent = yes
	has_character_flag = is_nerzhul
	has_global_flag = scourge_is_under_legion_control_flag

	trigger = {
		ai = no
		is_playable = yes
		independent = yes
		has_character_flag = is_nerzhul
		has_global_flag = scourge_is_under_legion_control_flag
		
		is_alive = yes
		is_dying = no

		OR = {
			NOT = { has_character_flag = first_lich_king_warning_flag }
			AND = {
				NOT = { has_character_flag = second_lich_king_warning_flag }
				ruled_years = 12
			}
			AND = {
				NOT = { has_character_flag = third_lich_king_warning_flag }
				ruled_years = 18
			}
			AND = {
				NOT = { has_character_flag = dead_lich_king_flag }
				ruled_years = 20
			}
		}
	}

	immediate = {
		# Finds dreadlord in realm
		if = {
			limit = {
				any_realm_character = {
					reverse_has_opinion_modifier = { who = ROOT modifier = opinion_jailer }
				}
			}
			random_realm_character = {
				limit = { reverse_has_opinion_modifier = { who = ROOT modifier = opinion_jailer } }
				save_event_target_as = target_dreadlord
			}
			if = {
				limit = { NOT = { has_character_flag = first_lich_king_warning_flag } }
				set_character_flag = first_lich_king_warning_flag
			}
			else_if = {
				limit = { NOT = { has_character_flag = second_lich_king_warning_flag } }
				set_character_flag = second_lich_king_warning_flag
			}
			else_if = {
				limit = { NOT = { has_character_flag = third_lich_king_warning_flag } }
				set_character_flag = third_lich_king_warning_flag
			}
			else = {
				set_character_flag = dead_lich_king_flag
			}
			narrative_event = { id = WCUND.110 }
		}
		else = {	# If there's no dreadlord, frees Ner'zhul
			narrative_event = { id = WCUND.115 }
		}
	}
}
narrative_event = {
	id = WCUND.110
	title = EVTTITLE_WCUND_110
	desc = {
		trigger = {
			has_character_flag = second_lich_king_warning_flag
			NOR = {
				has_character_flag = third_lich_king_warning_flag
				has_character_flag = dead_lich_king_flag
			}
		}
		text = EVTDESC_WCUND_110_second_warning
	}
	desc = {
		trigger = {
			has_character_flag = third_lich_king_warning_flag
			NOT = { has_character_flag = dead_lich_king_flag }
		}
		text = EVTDESC_WCUND_110_third_warning
	}
	desc = {
		trigger = {
			has_character_flag = dead_lich_king_flag
		}
		text = EVTDESC_WCUND_110_youre_pizdets
	}
	desc = {
		trigger = {
			has_character_flag = first_lich_king_warning_flag
			NOR = {
				has_character_flag = second_lich_king_warning_flag
				has_character_flag = third_lich_king_warning_flag
				has_character_flag = dead_lich_king_flag
			}
		}
		text = EVTDESC_WCUND_110_first_warning
	}
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_intrigue

	is_triggered_only = yes

	option = {
		name = EVTOPTA_WCUND_110

		if = {
			limit = {
				has_character_flag = dead_lich_king_flag
			}
			hidden_effect = {
				event_target:target_dreadlord = { wealth = ROOT }
				clear_wealth = yes
				any_demesne_title = {
					usurp_title = event_target:target_dreadlord
				}
			}
			death = { death_reason = death_battle killer = event_target:target_dreadlord }
		}
	}
}
# Lich King: All of your jailers are dead, incapable or imprisoned, you're free
narrative_event = {
	id = WCUND.115
	title = EVTTITLE_WCUND_115
	desc = EVTDESC_WCUND_115
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_intrigue

	is_triggered_only = yes
	
	immediate = {
		clr_global_flag = scourge_is_under_legion_control_flag
	}

	option = {
		name = EVTOPTA_WCUND_110

		custom_tooltip = {
			text = you_are_no_longer_pawn_of_the_legion_tooltip
		}
	}
}
# on_avoided_imprison_started_war
# on_became_imprisoned
# on_avoided_imprison_fled_country
# If you try to imprison your jailer, the dreadlords kills you
character_event = {
	id = WCUND.120

	is_triggered_only = yes
	hide_window = yes
	
	has_global_flag = scourge_is_under_legion_control_flag

	trigger = {
		FROM = {
			has_landed_title = e_scourge
			has_character_flag = is_nerzhul
			has_opinion_modifier = { who = ROOT modifier = opinion_jailer }
		}
	}

	immediate = {
		save_event_target_as = target_dreadlord
		if = {
			limit = { prisoner = yes }
			imprison = no
		}
		FROM = {
			set_character_flag = dead_lich_king_flag
			narrative_event = { id = WCUND.110 }
		}
	}
}

# The Scourge forms an alliance with the Legion (or not) when it arrived
narrative_event = {
	id = WCUND.130
	title = EVTTITLE_WCUND_130
	desc = EVTDESC_WCUND_130
	picture = GFX_evt_burning_legion
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes

	trigger = {
		e_burning_legion = { has_holder = yes }
		has_global_flag = scourge_is_under_legion_control_flag
	}

	# Form an alliance
	option = {
		name = EVTOPTA_WCUND_130

		e_burning_legion = {
			show_scope_change = no
			holder_scope = {
				show_scope_change = no
				hidden_effect = {
					ROOT = {
						any_vassal = {
							set_defacto_liege = PREVPREV
						}
					}
				}
				e_scourge = {
					show_scope_change = no
					activate_title = { title = e_scourge status = no }
					destroy_landed_title = THIS
				}
				if = {
					limit = { ai = yes }
					ROOT = {
						show_scope_change = no
						set_player_character = PREV
					}
				}
				hidden_effect = {
					ROOT = {
						any_demesne_title = {
							grant_title_no_opinion = PREVPREV
						}
					}
					# CPU HEAVY!
					any_province = {
						limit = { religion = death_god }
						religion = PREV
					}
					any_character = {
						limit = {
							OR = {
								religion = death_god
								secret_religion = death_god
							}
						}
						if = {
							limit = { religion = death_god }
							religion = PREV
						}
						if = {
							limit = { secret_religion = death_god }
							set_secret_religion = { target_type = public target = PREV }
						}
					}
					cult_of_the_damned = {
						any_society_member = {
							leave_society = yes
						}
					}
				}
			}
		}
		death = { death_reason = death_missing }

		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				NOT = { religion = burning_legion_religion }
			}
		}
	}

	# Break free
	option = {
		trigger = { NOT = { religion = burning_legion_religion } }
		name = EVTOPTA_WCUND_110

		hidden_effect = { e_burning_legion = { holder_scope = { add_rival = ROOT } } }
		# e_burning_legion = {
			# holder_scope = {
				# war = {
					# casus_belli = rivalry_cb
					# target = ROOT
				# }
			# }
		# }
		custom_tooltip = {
			text = you_are_no_longer_pawn_of_the_legion_tooltip
		}

		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				religion = burning_legion_religion
			}
		}
	}

	after = {
		clr_global_flag = scourge_is_under_legion_control_flag
		
		e_burning_legion = { holder_scope = { narrative_event = { id = WCUND.135 } } }
	}
}
# Notificates the Legion about the decision
narrative_event = {
	id = WCUND.135
	title = EVTTITLE_WCUND_130
	desc = {
		trigger = { has_global_flag = scourge_is_under_legion_control_flag }
		text = EVTDESC_WCUND_135_case_01
	}
	desc = {
		trigger = { NOT = { has_global_flag = scourge_is_under_legion_control_flag } }
		text = EVTDESC_WCUND_135_case_02
	}
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes

	option = {
		name = {
			trigger = { has_global_flag = scourge_is_under_legion_control_flag }
			text = EXCELLENT
		}
		name = {
			trigger = { NOT = { has_global_flag = scourge_is_under_legion_control_flag } }
			text = ALAS
		}
	}
}

# Undead character rots
character_event = {
	id = WCUND.150
	desc = {
		trigger = {
			NOR = {
				trait = skeleton
				trait = creature_lich
			}
		}
		text = EVTDESC_WCUND_150_flesh
	}
	desc = {
		trigger = {
			trait = skeleton
		}
		text = EVTDESC_WCUND_150_bones
	}
	picture = GFX_evt_cemetery
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	ai = no
	min_age = 60
	only_capable = yes
	prisoner = no

	trigger = {
		is_alive = yes
		is_dying = no
		
		is_humanoid_trigger = yes
		trait = being_undead
		NOR = {
			trait = creature_wraith
			trait = creature_banshee
			trait = creature_lich
			trait = vampire				# Have the vampiric hunger for instead
		}
		
		NOT = { trait = lich_king }
	}

	weight_multiplier = {
		days = 1

		modifier = {
			factor = 0.5
			is_maimed_trigger = yes
		}
		modifier = {
			factor = 0.75
			has_injury_trigger = yes
		}
	}

	option = {
		name = CURSES

		add_maimed_trait_effect = yes
	}

	after = {
		# character_event = { id = WCUND.200 days = 30 random = 30 }
	}
}

# Ping doctor
character_event = {
	id = WCUND.179

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		save_event_target_as = target_physician
		FROM  = { long_character_event = { id = WCUND.180 } }
	}
}
# Removes maimed traits for undead
long_character_event = {
	id = WCUND.180
	desc = {
		trigger = { has_character_flag = good_operation_outcome_flag }
		text = EVTDESC_WCUND_180_good
	}
	desc = {
		trigger = { has_character_flag = bad_operation_outcome_flag }
		text = EVTDESC_WCUND_180_bad
	}
	desc = {
		trigger = { has_character_flag = terrible_operation_outcome_flag }
		text = EVTDESC_WCUND_180_terrible
	}
	desc = {
		trigger = {
			trait = skeleton
		}
		text = EVTDESC_WCUND_180_bones
	}
	picture = GFX_evt_apothecary

	is_triggered_only = yes

	immediate = {
		random_list = {
			50 = {
				set_character_flag = good_operation_outcome_flag

				modifier = {
					factor = 1.2
					is_strong_trigger = yes
				}
				modifier = {
					factor = 1.2
					FROM = { trait = physician }
				}
				modifier = {
					factor = 1.2
					FROM = { learning = 25 }
				}
				modifier = {
					factor = 1.2
					FROM = { learning = 20 }
				}
				modifier = {
					factor = 1.2
					FROM = { learning = 15 }
				}
				modifier = {
					factor = 1.2
					FROM = { learning = 10 }
				}
				modifier = {
					factor = 1.2
					FROM = { physician_good_trigger = yes }
				}
			}
			30 = {
				set_character_flag = bad_operation_outcome_flag

				modifier = {
					factor = 1.6
					is_weak_trigger = yes
				}
				modifier = {
					factor = 1.6
					FROM = { NOT = { learning = 10 } }
				}
				modifier = {
					factor = 1.6
					FROM = { NOT = { learning = 5 } }
				}
				modifier = {
					factor = 1.6
					FROM = { physician_bad_trigger = yes }
				}

				modifier = {
					factor = 0
					OR = {
						trait = skeleton
						trait = creature_lich
					}
				}
			}
			20 = {
				set_character_flag = terrible_operation_outcome_flag

				modifier = {
					factor = 3
					trait = lunatic
				}
				modifier = {
					factor = 1.3
					is_weak_trigger = yes
				}
				modifier = {
					factor = 1.3
					FROM = { NOT = { learning = 10 } }
				}
				modifier = {
					factor = 1.3
					FROM = { NOT = { learning = 5 } }
				}
				modifier = {
					factor = 1.3
					FROM = { physician_bad_trigger = yes }
				}

				modifier = {
					factor = 0
					OR = {
						trait = skeleton
						trait = creature_lich
					}
				}
			}
		}
		if = {
			limit = {
				OR = {
					has_character_flag = good_operation_outcome_flag
					has_character_flag = bad_operation_outcome_flag
				}
			}
			remove_random_maimed_effect = yes
		}
	}

	option = {
		name = {
			trigger = { has_character_flag = good_operation_outcome_flag }
			text = EVTOPTA_WCUND_180_good
		}
		name = {
			trigger = { has_character_flag = bad_operation_outcome_flag }
			text = EVTOPTA_WCUND_180_bad
		}
		name = {
			trigger = { has_character_flag = terrible_operation_outcome_flag }
			text = EVTOPTA_WCUND_180_terrible
		}

		if = {
			limit = { has_character_flag = removed_maimed }
			remove_trait = maimed
		}
		if = {
			limit = { has_character_flag = removed_mangled }
			remove_trait = mangled
		}
		if = {
			limit = { has_character_flag = removed_one_eyed }
			remove_trait = one_eyed
		}
		if = {
			limit = { has_character_flag = removed_one_handed }
			remove_trait = one_handed
		}
		if = {
			limit = { has_character_flag = removed_one_legged }
			remove_trait = one_legged
		}
		if = {
			limit = { has_character_flag = removed_disfigured }
			remove_trait = disfigured
		}
		if = {
			limit = {
				trait = severely_injured
				OR = {
					has_character_flag = good_operation_outcome_flag
					has_character_flag = bad_operation_outcome_flag
				}
			}
			remove_trait = severely_injured
			if = {
				limit = { NOT = { trait = scarred } }
				add_trait = scarred
			}
		}
		if = {
			limit = { has_character_flag = bad_operation_outcome_flag }
			add_character_modifier = { name = operation_mistake duration = 730 }
		}
		if = {
			limit = { has_character_flag = terrible_operation_outcome_flag }
			add_character_modifier = { name = terrible_operation_mistake duration = 730 }
		}
	}

	after = {
		clr_character_flag = ongoing_operation_flag

		clr_character_flag = good_operation_outcome_flag
		clr_character_flag = bad_operation_outcome_flag
		clr_character_flag = terrible_operation_outcome_flag
	}
}

# Note: this event disabled
# 'Natural' transition into other undead form
character_event = {
	id = WCUND.200
	desc = {
		trigger = { NOT = { has_character_flag = transition_into_ghoul_flag } }
		text = EVTDESC_WCUND_200
		picture = GFX_evt_plague_eruptor
	}
	desc = {
		trigger = { has_character_flag = transition_into_ghoul_flag }
		text = EVTDESC_WCUND_200
		picture = GFX_evt_ghoul
	}
	picture = GFX_evt_plague_eruptor

	is_triggered_only = yes

	trigger = {
		is_humanoid_trigger = yes
		trait = being_undead
		NOR = {
			trait = creature_ghoul
			trait = creature_wraith
			trait = creature_banshee
			trait = creature_plague_eruptor
			trait = creature_abomination
			trait = skeleton
			trait = creature_lich
		}
		is_ruler = no
		dynasty = none

		has_severe_disability_trigger = yes
		OR = {
			# Transition into ghoul
			AND = {
				NOT = { trait = creature_ghoul }
				OR = {
					is_small_humanoid_trigger = yes
					is_medium_humanoid_trigger = yes
				}
				OR = {
					NOT = { learning = 5 }
					is_dumb_trigger = yes
				}
			}
			# Transition into skeleton
			AND = {
				NOT = { trait = skeleton }
				OR = {
					is_small_humanoid_trigger = yes
					is_medium_humanoid_trigger = yes
				}
				OR = {
					learning = 5
					is_smart_trigger = yes
				}
			}
			# Transition into plague eruptor
			AND = {
				NOT = { trait = creature_plague_eruptor }
				is_large_humanoid_trigger = yes
				OR = {
					trait = creature_ghoul
					NOT = { learning = 5 }
					is_dumb_trigger = yes
				}
			}
		}
	}

	immediate = {
		log = "WCUND.200 fired for [Root.GetBestName]"

		random_list = {
			# Transition into a ghoul
			10 = {
				modifier = {
					factor = 0
					OR = {
						trait = creature_ghoul
						NOR = {
							is_small_humanoid_trigger = yes
							is_medium_humanoid_trigger = yes
						}
						NOR = {
							NOT = { learning = 5 }
							is_dumb_trigger = yes
						}
					}
				}
				set_character_flag = transition_into_ghoul_flag
			}
			# Transition into a skeleton
			10 = {
				modifier = {
					factor = 0
					OR = {
						trait = skeleton
						NOR = {
							is_small_humanoid_trigger = yes
							is_medium_humanoid_trigger = yes
						}
						NOR = {
							learning = 5
							is_smart_trigger = yes
						}
					}
				}
				set_character_flag = transition_into_skeleton_flag
			}
			# Transition into plague eruptor
			10 = {
				modifier = {
					factor = 0
					OR = {
						trait = creature_plague_eruptor
						NOT = { is_large_humanoid_trigger = yes }
						NOR = {
							trait = creature_ghoul
							NOT = { learning = 5 }
							is_dumb_trigger = yes
						}
					}
				}
				set_character_flag = transition_into_plague_eruptor_flag
			}
		}
	}

	weight_multiplier = {
		days = 1
	}

	option = {
		name = {
			trigger = { NOT = { has_character_flag = transition_into_skeleton_flag } }
			text = EVTOPTA_WCUND_200_case_01
		}
		name = {
			trigger = { has_character_flag = transition_into_skeleton_flag }
			text = EVTOPTA_WCUND_200_case_02
		}
		remove_racial_traits_effect = yes
		trigger_switch = {
			on_trigger = has_character_flag
			transition_into_ghoul_flag = {
				clr_character_flag = transition_into_ghoul_flag
				add_trait = creature_ghoul
			}
			transition_into_skeleton_flag = {
				clr_character_flag = transition_into_skeleton_flag
				add_trait = skeleton
			}
			transition_into_plague_eruptor_flag = {
				clr_character_flag = transition_into_plague_eruptor_flag
				add_trait = creature_plague_eruptor
			}
		}

		# Fixes immortal age
		add_age_back_effect = yes

		if = { limit = { trait = infirm 		} remove_trait = infirm 		}
		if = { limit = { trait = mangled 		} remove_trait = mangled 		}
		if = { limit = { trait = inbred 		} remove_trait = inbred 		}
		if = { limit = { trait = blinded 		} remove_trait = blinded 		}
		if = { limit = { is_incapable = yes 		} remove_trait = incapable 		}
		if = { limit = { trait = maimed 		} remove_trait = maimed 		}
	}
}
# Chooses form of undead
character_event = {
	id = WCUND.300
	desc = {
		trigger = { event_target:target_undead = { NOT = { character = ROOT } } }
		text = EVTDESC_WCUND_300_another
	}
	desc = {
		trigger = { event_target:target_undead = { character = ROOT } }
		text = EVTDESC_WCUND_300_self
	}
	picture = GFX_evt_cemetery
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	# Just an undead
	option = {
		trigger = {
			OR = {
				NOT = {
					event_target:target_undead = {
						has_class_trait_trigger = yes
						is_alternative_class_trigger = no
					}
				}
				NOR = {
					event_target:target_undead = { is_paladin_class_trigger = yes }
					has_7_8_magic_class_or_higher_trigger = yes
					trait = lich_king
					AND = {
						society_member_of = cult_of_the_damned
						is_society_grandmaster = yes
					}
				}
			}
		}
		name = EVTOPTA_WCUND_300

		tooltip = {
			event_target:target_undead = {
				add_trait_undead_effect = yes
				if = {
					limit = { event_target:target_undead = { NOT = { character = ROOT } } }
					opinion = {
						modifier = opinion_loyal_servant
						who = ROOT
					}
				}
			}
		}
		hidden_effect = { event_target:target_undead = { character_event = { id = WCPOD.5013 } } }

		ai_chance = {
			factor = 15
		}
	}

	# Ghost
	option = {
		trigger = {
			always = no

			event_target:target_undead = { NOT = { character = ROOT } }
			NOR = {
				event_target:target_undead = { is_paladin_class_trigger = yes }
				has_7_8_magic_class_or_higher_trigger = yes
				trait = lich_king
				AND = {
					society_member_of = cult_of_the_damned
					is_society_grandmaster = yes
				}
			}
		}
		name = EVTOPTB_WCUND_300

		event_target:target_undead = {
			set_character_flag = transition_into_wraith_flag
			tooltip = {
				remove_racial_traits_effect = yes
				add_trait = creature_wraith
				add_trait_undead_effect = yes
				if = {
					limit = { event_target:target_undead = { NOT = { character = ROOT } } }
					opinion = {
						modifier = opinion_loyal_servant
						who = ROOT
					}
				}
			}
		}
		hidden_effect = { event_target:target_undead = { character_event = { id = WCPOD.5013 } } }

		ai_chance = {
			factor = 5
		}
	}

	# Vampire
	option = {
		trigger = {
			NOT = { event_target:target_undead = { is_paladin_class_trigger = yes } }
			OR = {
				has_7_8_magic_class_or_higher_trigger = yes
				trait = lich_king
				AND = {
					society_member_of = cult_of_the_damned
					is_society_grandmaster = yes
				}
			}
		}
		name = EVTOPTD_WCUND_300

		event_target:target_undead = {
			set_character_flag = transition_into_vampire_flag
			tooltip = {
				add_trait_undead_effect = yes
				add_trait = vampire
				if = {
					limit = { event_target:target_undead = { NOT = { character = ROOT } } }
					opinion = {
						modifier = opinion_loyal_servant
						who = ROOT
					}
				}
			}
		}
		hidden_effect = { event_target:target_undead = { character_event = { id = WCPOD.5013 } } }

		ai_chance = {
			factor = 5
		}
	}

	# Death Knight
	option = {
		trigger = {
			event_target:target_undead = {
				has_class_trait_trigger = yes
				is_alternative_class_trigger = no
			}
			OR = {
				event_target:target_undead = { is_paladin_class_trigger = yes }
				has_7_8_magic_class_or_higher_trigger = yes
				trait = lich_king
				AND = {
					society_member_of = cult_of_the_damned
					is_society_grandmaster = yes
				}
			}
		}
		name = EVTOPTC_WCUND_300

		event_target:target_undead = {
			set_character_flag = transition_into_death_knight_flag
			tooltip = {
				add_trait_undead_effect = yes
				custom_tooltip = { text = becomes_death_knight }
				if = {
					limit = { event_target:target_undead = { NOT = { character = ROOT } } }
					opinion = {
						modifier = opinion_loyal_servant
						who = ROOT
					}
				}
			}
		}
		hidden_effect = { event_target:target_undead = { character_event = { id = WCPOD.5013 } } }

		ai_chance = {
			factor = 50
		}
	}

	# Lich
	option = {
		trigger = {
			NOT = { event_target:target_undead = { is_paladin_class_trigger = yes } }
			OR = {
				has_7_8_magic_class_or_higher_trigger = yes
				trait = lich_king
				AND = {
					society_member_of = cult_of_the_damned
					is_society_grandmaster = yes
				}
			}
		}
		name = EVTOPTF_WCUND_300

		event_target:target_undead = {
			set_character_flag = transition_into_lich_flag
			tooltip = {
				remove_racial_traits_effect = yes
				add_trait = creature_lich
				add_trait_undead_effect = yes
				if = {
					limit = { event_target:target_undead = { NOT = { character = ROOT } } }
					opinion = {
						modifier = opinion_loyal_servant
						who = ROOT
					}
				}
			}
		}
		hidden_effect = { event_target:target_undead = { character_event = { id = WCPOD.5013 } } }

		ai_chance = {
			factor = 25
		}
	}

	# No, I changed my mind
	option = {
		trigger = { event_target:target_undead = { character = ROOT } }
		name = EVTOPTE_WCUND_300

		event_target:target_undead = { clr_character_flag = being_raised_flag }

		ai_chance = {
			factor = 0
		}
	}
}

#######################################
# The Creation of a monstrous undead
#######################################
character_event = {
	id = WCUND.350
	desc = EVTDESC_WCUND_350
	picture = GFX_evt_apothecary
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	option = {
		name = EVTOPTA_WCUND_350
	}

	after = {
		character_event = { id = WCUND.355 }
	}
}

# Remove the higher cognitive functions?
character_event = {
	id = WCUND.355
	desc = EVTDESC_WCUND_355
	picture = GFX_evt_apothecary
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	show_from_from = yes

	option = {
		name = EVTOPTA_WCUND_355

		custom_tooltip = { text = EVTOPTA_WCUND_355_tooltip }
		event_target:target_prisoner = {
			random_list = {
				10 = {
					modifier = {
						factor = 1.5
						trait = genius
					}
					modifier = {
						factor = 1.3
						trait = quick
					}
					modifier = {
						factor = 1.3
						trait = shrewd
					}
				}
				40 = {
					tooltip = { add_trait = slow }
					hidden_effect = { ROOT = { set_character_flag = slow_mn_flag } }

					modifier = {
						factor = 1.5
						trait = imbecile
					}
					modifier = {
						factor = 1.3
						trait = slow
					}
					modifier = {
						factor = 1.3
						trait = dull
					}
				}
				50 = {
					tooltip = { add_trait = imbecile }
					hidden_effect = { ROOT = { set_character_flag = imbecile_mn_flag } }

					modifier = {
						factor = 1.5
						trait = imbecile
					}
					modifier = {
						factor = 1.3
						trait = slow
					}
					modifier = {
						factor = 1.3
						trait = dull
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTB_WCUND_355

		event_target:target_prisoner = {
			random_list = {
				65 = {
					modifier = {
						factor = 1.5
						trait = genius
					}
					modifier = {
						factor = 1.3
						trait = quick
					}
					modifier = {
						factor = 1.3
						trait = shrewd
					}
				}
				20 = {
					tooltip = { add_trait = slow }
					hidden_effect = { ROOT = { set_character_flag = slow_mn_flag } }

					modifier = {
						factor = 1.5
						trait = imbecile
					}
					modifier = {
						factor = 1.3
						trait = slow
					}
					modifier = {
						factor = 1.3
						trait = dull
					}
				}
				15 = {
					tooltip = { add_trait = imbecile }
					hidden_effect = { ROOT = { set_character_flag = imbecile_mn_flag } }

					modifier = {
						factor = 1.5
						trait = imbecile
					}
					modifier = {
						factor = 1.3
						trait = slow
					}
					modifier = {
						factor = 1.3
						trait = dull
					}
				}
			}
		}
	}

	after = {
		# Monstrous undead
		create_character = {
			dynasty = none
			religion = ROOT
			culture = ROOT
			female = no
			age = 20
		}
		hidden_effect = {
			new_character = {
				# Add race trait
				set_character_flag = transition_into_abomination_flag
				character_event = { id = WCPOD.5013 }
				if = {
					limit = {
						NOT = { trait = slow }
						ROOT = { has_character_flag = slow_mn_flag }
					}
					add_trait = slow
				}
				if = {
					limit = {
						NOT = { trait = imbecile }
						ROOT = { has_character_flag = imbecile_mn_flag }
					}
					add_trait = imbecile
				}
				remove_education_effect = yes
				random_list = {
					10 = {
						add_trait = misguided_warrior
						add_trait = class_warrior_2
					}
					45 = {
						add_trait = tough_soldier
						add_trait = class_warrior_3

						modifier = {
							factor = 0.5
							trait = slow
						}
						modifier = {
							factor = 0.5
							trait = imbecile
						}
					}
					30 = {
						add_trait = skilled_tactician
						add_trait = class_warrior_4

						modifier = {
							factor = 0.1
							trait = slow
						}
						modifier = {
							factor = 0.1
							trait = imbecile
						}
					}
					15 = {
						add_trait = brilliant_strategist
						add_trait = class_warrior_5

						modifier = {
							factor = 0.1
							trait = slow
						}
						modifier = {
							factor = 0.1
							trait = imbecile
						}
					}
				}
				event_target:target_prisoner = { death = { death_reason = death_missing } }
				character_event = { id = WCUND.359 }
			}
		}
	}
}
# Ping event
character_event = {
	id = WCUND.359

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		event_target:target_necromancer = { character_event = { id = WCUND.360 } }
	}
}
# Notification about the end
character_event = {
	id = WCUND.360
	desc = EVTDESC_WCUND_360
	picture = GFX_evt_apothecary
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	option = {
		name = EXCELLENT

		hidden_effect = { clr_character_flag = being_raised_flag }
	}
}

#########################################
# The Transformation into an Abomination
#########################################
# The first phase of the operation
character_event = {
	id = WCUND.370
	desc = EVTDESC_WCUND_370
	picture = GFX_evt_apothecary
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	option = {
		name = EVTOPTA_WCUND_370
	}

	after = {
		character_event = { id = WCUND.375 }
	}
}
# The end
character_event = {
	id = WCUND.375
	desc = EVTDESC_WCUND_375
	picture = GFX_evt_apothecary
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	option = {
		name = EVTOPTA_WCUND_375

		remove_racial_traits_effect = yes
		add_trait = creature_abomination

		# Fixes immortal age
		add_age_back_effect = yes

		hidden_effect = { set_graphical_culture = abomination }
	}

	after = {
		clr_character_flag = ongoing_turning_into_monstrous_undead_flag
		clr_character_flag = being_raised_flag
	}
}

###############################
# The Merging with a Lich King
###############################
# Want you merge?
narrative_event = {
	id = WCUND.500
	title = EVTTITLE_WCUND_500
	desc = EVTDESC_WCUND_500
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes

	min_age = 16
	only_playable = yes
	only_capable = yes
	prisoner = no

	trigger = {
		always = no	# TODO
		
		is_adult = yes
		is_incapable = no
		prisoner = no
		is_inaccessible_trigger = no

		e_scourge = {
			holder_scope = {
				trait = creature_wraith
				trait = lich_king
				OR = {
					has_character_modifier = mind_control_3
					has_character_modifier = mind_control_4
				}
			}
		}

		trait = champion_of_the_lich_king				# You're the champion
	}

	immediate = {
		e_scourge = { holder_scope = { save_event_target_as = target_lich_king } }
		set_global_flag = merging_with_the_lich_king
	}

	option = {
		name = EVTOPTA_WCUND_500
		narrative_event = { id = WCUND.550 days = 30 }
	}
	option = {
		name = EVTOPTB_WCUND_500

		clr_global_flag = merging_with_the_lich_king

		ai_chance = {
			factor = 0
		}
	}
}
# Merges you
narrative_event = {
	id = WCUND.550
	title = EVTTITLE_WCUND_550
	desc = EVTDESC_WCUND_550
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes

	trigger = { has_global_flag = merging_with_the_lich_king }

	option = {
		name = EVTOPTA_WCUND_550

		if = {
			limit = { OR = { is_republic = yes is_theocracy = yes is_tribal = yes } }
			abdicate = yes
		}
		if = {
			limit = { is_female = no }
			custom_tooltip = { text = becomes_the_new_lich_king_tooltip }
		}
		if = {
			limit = { is_female = yes }
			custom_tooltip = { text = becomes_the_new_lich_queen_tooltip }
		}
		hidden_tooltip = {
			e_scourge = {
				holder_scope = {
					ROOT = { wealth = PREV }
					clear_wealth = yes
					abdicate_to = ROOT
					death = { death_reason = death_merged killer = ROOT }
				}
			}
		}
	}
}
# The New Lich King
narrative_event = {
	id = WCUND.551
	title = {
		trigger = { ROOT = { has_character_flag = is_nerzhul } }
		text = EVTTITLE_WCUND_100
	}
	desc = {
		trigger = { ROOT = { has_character_flag = is_nerzhul } }
		text = EVTDESC_WCUND_100
	}
	title = {
		trigger = { ROOT = { NOT = { has_character_flag = is_nerzhul } } }
		text = EVTTITLE_WCUND_551
	}
	desc = {
		trigger = { ROOT = { NOT = { has_character_flag = is_nerzhul } } }
		text = EVTDESC_WCUND_551
	}
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_diplomacy

	is_triggered_only = yes

	major = yes
	major_trigger = {
		ai = no
	}
	show_root = yes

	immediate = { clr_global_flag = merging_with_the_lich_king }

	option = {
		name = {
			trigger = {
				NOT = { character = ROOT }
				opinion = { who = ROOT value = 10 }
			}
			text = EVTOPTA_WCUND_551_case_1
		}
		name = {
			trigger = {
				NOT = { character = ROOT }
				NOT = { opinion = { who = ROOT value = 10 } }
			}
			text = EVTOPTA_WCUND_551_case_2
		}
		name = {
			trigger = { character = ROOT }
			text = EVTOPTA_WCUND_551_case_3
		}
	}
}
# on_new_holder e_scourge
character_event = {
	id = WCUND.552

	is_triggered_only = yes
	hide_window = yes
	
	only_playable = yes
	only_independent = yes

	trigger = {
		FROM = {
			title = e_scourge
		}
	}

	immediate = {
		log = "WCUND.552 fired for [Root.GetBestName]"

		clear_secret_religion = yes
		if = {
			limit = {
				NOR = {
					religion = death_god
					religion = burning_legion_religion
				}
			}
			religion = death_god
		}
		culture = scourge
		if = {
			limit = {
				NOT = { trait = being_undead }
				can_be_undead_trigger = yes
			}
			set_character_flag = transition_into_lich_flag
			character_event = { id = WCPOD.5013 }
		}
		add_trait = lich_king
		if = {
			limit = { trait = champion_of_the_lich_king }
			remove_trait = champion_of_the_lich_king
		}
		FROMFROM = {
			if = {
				limit = { is_alive = yes }
				death = { death_reason = death_merged killer = ROOT }
			}
		}
		character_event = { id = WCUND.1106 days = 1 }
		narrative_event = { id = WCUND.551 }
	}
}

# Becomes the champion of the lich king
narrative_event = {
	id = WCUND.560
	title = EVTTITLE_WCUND_560
	desc = EVTDESC_WCUND_560
	picture = GFX_evt_icecrown
	border = GFX_event_narrative_frame_diplomacy

	is_triggered_only = yes

	option = {
		name = EXCELLENT

		add_trait = champion_of_the_lich_king
	}
}

# Vampiric Hunger
character_event = {
	id = WCUND.605
	desc = EVTDESC_WCUND_605
	picture = GFX_evt_cemetery
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	ai = no
	only_playable = yes
	min_age = 16
	prisoner = no
	only_capable = yes

	trigger = {
		is_alive = yes
		is_dying = no
		
		trait = vampire
		
		NOT = { has_character_modifier = moderate_blood_thirst }
	}

	option = {
		name = EVTOPTA_WCUND_605

		increase_vampiric_hunger_effect = yes
	}
}

# Lich returns its corporeal body
character_event = {
	id = WCUND.900
	desc = EVTDESC_WCUND_900
	picture = GFX_evt_lich
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	option = {
		name = EXCELLENT

		remove_trait = lost_corporeal_body
	}
}

# Troops finds lich's phylactery
character_event = {
	id = WCUND.920
	desc = EVTDESC_WCUND_920
	picture = GFX_evt_lich
	border = GFX_event_normal_frame_war

	is_triggered_only = yes
	
	only_playable = yes

	trigger = {
		FROM = {
			holder_scope = {
				NOT = { same_realm = ROOT }
				
				trait = creature_lich
				NOT = { has_landed_title = e_scourge }
				capital_holding = { title = FROM }
			}
		}
	}

	immediate = {
		FROM = { holder_scope = { save_event_target_as = target_lich } }
	}

	# Kill it!
	option = {
		name = EVTOPTA_WCUND_920

		event_target:target_lich = {
			character_event = { id = WCUND.925 }
			death = { death_reason = death_battle killer = ROOT }
		}
	}
	# No
	option = {
		name = EVTOPTB_WCUND_920
	}
}
character_event = {
	id = WCUND.925
	desc = EVTDESC_WCUND_925
	picture = GFX_evt_lich
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = ALAS
	}
}

# Increases power of mind control.
# This stages important only for Lich King
# Stages:
# 1) mind_control_1 - 100-75	- If the LK reach this stage, he has a 100% chance to make any undead in the realm his servant.
# 2) mind_control_2 - 74-50 	- If the LK reach this stage, he has a 50% chance to make any undead in the realm his servant.
# 3) mind_control_3 - 49-25 	- If the LK reach this stage, he has a 25% chance to make any undead in the realm his servant.
# 4) mind_control_4 - 24-0
character_event = {
	id = WCUND.1106
	desc = {
		trigger = {
			NOR = {
				is_necromancer_class_trigger = yes
				has_landed_title = e_scourge
			}
		}
		text = EVTDESC_WCCLS_1106
		picture = GFX_evt_mind_control
	}
	desc = {
		trigger = {
			OR = {
				is_necromancer_class_trigger = yes
				has_landed_title = e_scourge
			}
		}
		text = EVTDESC_WCCLS_1106
		picture = GFX_evt_scourge_army
	}

	is_triggered_only = yes

	only_playable = yes

	trigger = {
		OR = {
			AND = {
				NOT = { has_character_modifier = mind_control_1 }
				has_character_modifier = mind_control_2
				check_variable = { which = mind_control_power value = 75 }
			}
			AND = {
				NOT = { has_character_modifier = mind_control_2 }
				has_character_modifier = mind_control_3
				check_variable = { which = mind_control_power value = 50 }
			}
			AND = {
				NOT = { has_character_modifier = mind_control_3 }
				has_character_modifier = mind_control_4
				check_variable = { which = mind_control_power value = 25 }
			}
			# You're a Lich King, but don't have modifier
			AND = {
				has_landed_title = e_scourge
				NOR = {
					has_character_modifier = mind_control_1
					has_character_modifier = mind_control_2
					has_character_modifier = mind_control_3
					has_character_modifier = mind_control_4
				}
			}
		}
	}
	
	immediate = {
		log = "WCUND.1106 fired for [Root.GetBestName]"
	}

	option = {
		name = EXCELLENT

		hidden_effect = {
			any_demesne_province = {
				limit = {
					NOT = { religion = ROOT }
					has_province_modifier = undead_province
				}
				religion = ROOT
			}
		}
		if = {
			limit = {
				NOT = { has_character_modifier = mind_control_1 }
				has_character_modifier = mind_control_2
				check_variable = { which = mind_control_power value = 75 }
			}
			remove_character_modifier = mind_control_2
			add_character_modifier = { name = mind_control_1 duration = -1 }
			if = {
				limit = { has_landed_title = e_scourge }
				hidden_effect = {
					any_realm_character = {
						limit = {
							NOT = { character = ROOT }
							trait = being_undead
							NOT = { has_character_flag = freed_from_lich_king_flag }
							NOT = { has_landed_title = e_scourge }
							e_scourge = {
								has_holder = yes
								holder_scope = {
									NOT = { religion = PREVPREV }
								}
							}
						}
						character_event = { id = WCUND.1108 days = 1 }		# Check religion
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { has_character_modifier = mind_control_2 }
				has_character_modifier = mind_control_3
				check_variable = { which = mind_control_power value = 50 }
			}
			remove_character_modifier = mind_control_3
			add_character_modifier = { name = mind_control_2 duration = -1 }
			if = {
				limit = { has_landed_title = e_scourge }
				hidden_effect = {
					any_realm_character = {
						limit = {
							NOT = { character = ROOT }
							trait = being_undead
							NOT = { has_character_flag = freed_from_lich_king_flag }
							NOT = { has_landed_title = e_scourge }
							e_scourge = {
								has_holder = yes
								holder_scope = {
									NOT = { religion = PREVPREV }
								}
							}
						}
						random = {
							chance = 50
							character_event = { id = WCUND.1108 days = 1 }		# Check religion
						}
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { has_character_modifier = mind_control_3 }
				has_character_modifier = mind_control_4
				check_variable = { which = mind_control_power value = 25 }
			}
			remove_character_modifier = mind_control_4
			add_character_modifier = { name = mind_control_3 duration = -1 }
			if = {
				limit = { has_landed_title = e_scourge }
				hidden_effect = {
					any_realm_character = {
						limit = {
							NOT = { character = ROOT }
							trait = being_undead
							NOT = { has_character_flag = freed_from_lich_king_flag }
							NOT = { has_landed_title = e_scourge }
							e_scourge = {
								has_holder = yes
								holder_scope = {
									NOT = { religion = PREVPREV }
								}
							}
						}
						random = {
							chance = 25
							character_event = { id = WCUND.1108 days = 1 }		# Check religion
						}
					}
				}
			}
		}
		if = {
			limit = {
				NOR = {
					has_character_modifier = mind_control_1
					has_character_modifier = mind_control_2
					has_character_modifier = mind_control_3
					has_character_modifier = mind_control_4
				}
			}
			hidden_effect = { set_variable = { which = mind_control_power value = 100 } }
			add_character_modifier = { name = mind_control_1 duration = -1 }
			if = {
				limit = { has_landed_title = e_scourge }
				hidden_effect = {
					any_realm_character = {
						limit = {
							NOT = { character = ROOT }
							trait = being_undead
							NOT = { has_character_flag = freed_from_lich_king_flag }
							NOT = { has_landed_title = e_scourge }
							e_scourge = {
								has_holder = yes
								holder_scope = {
									NOT = { religion = PREVPREV }
								}
							}
						}
						character_event = { id = WCUND.1108 days = 1 }		# Check religion
					}
				}
			}
		}
	}
}
# Decreases power of mind control
# Stages:
# 1) mind_control_1 - 100-75
# 2) mind_control_2 - 74-50 	- If you descend to this stage, you lose 25% of your servants.
# 3) mind_control_3 - 49-25 	- If you descend to this stage, you lose 50% of your servants.
# 4) mind_control_4 - 24-0 		- If you descend to this stage, you lose 100% of your servants.
character_event = {
	id = WCUND.1107
	desc = {
		trigger = {
			NOR = {
				is_necromancer_class_trigger = yes
				has_landed_title = e_scourge
			}
		}
		text = EVTDESC_WCCLS_1107
		picture = GFX_evt_mind_control
	}
	desc = {
		trigger = {
			OR = {
				is_necromancer_class_trigger = yes
				has_landed_title = e_scourge
			}
		}
		text = EVTDESC_WCCLS_1107
		picture = GFX_evt_scourge_army
	}

	is_triggered_only = yes

	only_playable = yes

	trigger = {
		OR = {
			AND = {
				has_character_modifier = mind_control_1
				NOT = { has_character_modifier = mind_control_2 }
				NOT = { check_variable = { which = mind_control_power value = 75 } }
			}
			AND = {
				has_character_modifier = mind_control_2
				NOT = { has_character_modifier = mind_control_3 }
				NOT = { check_variable = { which = mind_control_power value = 50 } }
			}
			AND = {
				has_character_modifier = mind_control_3
				NOT = { has_character_modifier = mind_control_4 }
				NOT = { check_variable = { which = mind_control_power value = 25 } }
			}
		}
	}
	
	immediate = {
		log = "WCUND.1107 fired for [Root.GetBestName]"
	}

	option = {
		name = ALAS
		if = {
			limit = {
				has_character_modifier = mind_control_3
				NOT = { has_character_modifier = mind_control_4 }
				NOT = { check_variable = { which = mind_control_power value = 25 } }
			}
			remove_character_modifier = mind_control_3
			add_character_modifier = { name = mind_control_4 duration = -1 }
			hidden_effect = {
				any_realm_character = {
					limit = {
						NOT = { character = ROOT }
						trait = being_undead
						NOT = { trait = champion_of_the_lich_king }
						NOT = { has_landed_title = e_scourge }
						e_scourge = {
							has_holder = yes
							holder_scope = {
								religion = PREVPREV
							}
						}
					}
					random = {
						chance = 75
						modifier = {
							factor = 0.1
							location = { region = world_northrend }
						}
						free_from_lich_king_effect = yes
					}
				}
			}
		}
		if = {
			limit = {
				has_character_modifier = mind_control_2
				NOT = { has_character_modifier = mind_control_3 }
				NOT = { check_variable = { which = mind_control_power value = 50 } }
			}
			remove_character_modifier = mind_control_2
			add_character_modifier = { name = mind_control_3 duration = -1 }
			hidden_effect = {
				any_realm_character = {
					limit = {
						NOT = { character = ROOT }
						trait = being_undead
						NOT = { trait = champion_of_the_lich_king }
						NOT = { has_landed_title = e_scourge }
						e_scourge = {
							has_holder = yes
							holder_scope = {
								religion = PREVPREV
							}
						}
					}
					random = {
						chance = 50
						modifier = {
							factor = 0.1
							location = { region = world_northrend }
						}
						free_from_lich_king_effect = yes
					}
				}
			}
		}
		if = {
			limit = {
				has_character_modifier = mind_control_1
				NOT = { has_character_modifier = mind_control_2 }
				NOT = { check_variable = { which = mind_control_power value = 75 } }
			}
			remove_character_modifier = mind_control_1
			add_character_modifier = { name = mind_control_2 duration = -1 }
			hidden_effect = {
				any_realm_character = {
					limit = {
						NOT = { character = PREV }
						trait = being_undead
						NOT = { trait = champion_of_the_lich_king }
						NOT = { has_landed_title = e_scourge }
						e_scourge = {
							has_holder = yes
							holder_scope = {
								religion = PREVPREV
							}
						}
					}
					random = {
						chance = 25
						modifier = {
							factor = 0.1
							location = { region = world_northrend }
						}
						free_from_lich_king_effect = yes
					}
				}
			}
		}
	}
}

# Undead becomes a servant of the LK - event is problematic
character_event = {
	id = WCUND.1108
	desc = EVTDESC_WCCLS_1108
	picture = GFX_evt_scourge_army

	is_triggered_only = yes

	trigger = {
		trait = being_undead
		NOT = { has_character_flag = freed_from_lich_king_flag }
		NOT = { has_landed_title = e_scourge }
		e_scourge = {
			has_holder = yes
			holder_scope = {
				NOT = { religion = PREVPREV }
			}
		}
	}

	immediate = {
		log = "WCUND.1108 fired for [Root.GetBestName]"
	}

	option = {
		name = ALAS

		e_scourge = {
			show_scope_change = no
			holder_scope = {
				show_scope_change = no
				ROOT = {
					show_scope_change = no
					if = {
						limit = { NOT = { religion = PREV } }
						religion = PREV
					}
					if = {
						limit = { has_secret_religion = yes }
						clear_secret_religion = yes
					}
					hidden_effect = {
						if = {
							limit = {
								is_ruler = yes
								higher_tier_than = COUNT
							}
							any_demesne_province = {
								limit = {
									NOT = { religion = PREVPREV }
									has_province_modifier = undead_province
								}
								religion = PREVPREV
							}
						}
					}
					if = {
						limit = { has_opinion_modifier = { who = PREV  modifier = opinion_evil_tyrant } }
						remove_opinion = { modifier = opinion_evil_tyrant who = PREV }
					}
					if = {
						limit = { NOT = { has_opinion_modifier = { who = PREV  modifier = opinion_loyal_servant } } }
						opinion = { modifier = opinion_loyal_servant who = PREV }
					}
				}
			}
		}
	}
}
# Undead becomes free
character_event = {
	id = WCUND.1109
	desc = EVTDESC_WCCLS_1109
	picture = GFX_evt_scourge_army

	is_triggered_only = yes

	immediate = {
		log = "WCUND.1109 fired for [Root.GetBestName]"
	}

	option = {
		name = EVTOPTA_WCCLS_1109

		set_character_flag = freed_from_lich_king_flag
		e_scourge = {
			show_scope_change = no
			holder_scope = {
				show_scope_change = no
				ROOT = {
					show_scope_change = no
					if = {
						limit = {
							is_ruler = yes
							independent = no
							
							higher_tier_than = BARON
						}
						set_defacto_liege = THIS
					}
					remove_opinion = { modifier = opinion_loyal_servant who = PREV }
					opinion = { modifier = opinion_evil_tyrant who = PREV }
					if = {
						limit = {
							religion = PREV
						}
						if = {
							limit = { has_secret_religion = yes }
							convert_to_secret_religion = yes
							break = yes
						}
						if = {
							limit = {
								is_ruler = yes
								capital_scope = { evil_public_religion_trigger = no }
							}
							capital_scope = {
								show_scope_change = no
								ROOT = {
									show_scope_change = no
									religion = PREV
								}
							}
							break = yes
						}
						# Clean-up
						religion = forsaken_cult
					}
				}
			}
		}
		
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.59
				has_benevolent_trait_trigger = yes
			}
			modifier = {
				factor = 1.59
				has_pleasant_trait_trigger = yes
			}
			modifier = {
				factor = 1.59
				has_pious_trait_trigger = yes
			}
		}
	}

	option = {
		trigger = { NOT = { e_scourge = { holder_scope = { war_with = ROOT } } } }
		name = EVTOPTB_WCCLS_1109
		
		ai_chance = {
			factor = 50
			modifier = {
				factor = 1.59
				has_evil_trait_trigger = yes
			}
			modifier = {
				factor = 1.59
				has_unpleasant_trait_trigger = yes
			}
			modifier = {
				factor = 1.59
				has_impious_trait_trigger = yes
			}
		}
	}
}

# Removes mind control power (TODO)
# on_yearly_pulse
character_event = {
	id = WCUND.1110

	is_triggered_only = yes
	hide_window = yes
	
	only_playable = yes
	only_independent = yes

	trigger = {
		is_alive = yes
		is_dying = no
		
		OR = {
			has_character_modifier = mind_control_1
			has_character_modifier = mind_control_2
			has_character_modifier = mind_control_3
			has_character_modifier = mind_control_4
		}
		check_variable = { which = mind_control_power value = 1 }
	}

	immediate = {
		remove_3_mind_control_power_effect = yes
	}
}

# Adds mind control power
# on_battle_won_owner
character_event = {
	id = WCUND.1111

	is_triggered_only = yes
	hide_window = yes
	
	only_playable = yes
	only_independent = yes

	trigger = {
		is_alive = yes
		is_dying = no
		
		OR = {
			has_character_modifier = mind_control_1
			has_character_modifier = mind_control_2
			has_character_modifier = mind_control_3
			has_character_modifier = mind_control_4
		}
		NOT = { check_variable = { which = mind_control_power value = 100 } }
	}

	immediate = {
		add_5_mind_control_power_effect = yes
	}
}
# Removes mind control power
# on_battle_lost_owner
character_event = {
	id = WCUND.1112

	is_triggered_only = yes
	hide_window = yes
	
	only_playable = yes
	only_independent = yes

	trigger = {
		is_alive = yes
		is_dying = no
		
		OR = {
			has_character_modifier = mind_control_1
			has_character_modifier = mind_control_2
			has_character_modifier = mind_control_3
			has_character_modifier = mind_control_4
		}
		check_variable = { which = mind_control_power value = 1 }
	}

	immediate = {
		remove_5_mind_control_power_effect = yes
	}
}

# Kills Ner'zhul if he isn't a Lick King anymore
character_event = {
	id = WCUND.1200

	is_triggered_only = yes
	hide_window = yes
	
	has_character_flag = is_nerzhul

	immediate = {
		death = { death_reason = death_missing }
	}
}

# If character isn't a dark worshipper, converts to the necromantic religions
character_event = {
	id = WCUND.1301
	desc = EVTDESC_WCUND_1301
	picture = GFX_evt_cemetery

	is_triggered_only = yes

	trigger = {
		NOT = { has_character_flag = necromancy_group_switch_flag }
		
		dark_true_religion_trigger = no
		NOT = { true_religion_group = loa_group }		# Because of Bwonsamdi
	}
	
	immediate = {
		set_character_flag = necromancy_group_switch_flag
	}

	# I will not serve anyone!
	option = {
		name = EVTOPTA_WCUND_1301

		if = {
			limit = {
				OR = {
					is_dark_being_trigger = yes
					liege = { religion = shadowlander }
				}
			}
			if = { limit = { has_secret_religion = yes } clear_secret_religion = yes }
			religion = shadowlander
		}
		else = { set_secret_religion = shadowlander }

		ai_chance = {
			factor = 50
		}
	}

	# I'll serve the Lich King!
	option = {
		trigger = {
			has_global_flag = lich_king_happened
		}
		name = EVTOPTB_WCUND_1301

		if = {
			limit = {
				OR = {
					is_dark_being_trigger = yes
					liege = { religion = death_god }
				}
			}
			if = { limit = { has_secret_religion = yes } clear_secret_religion = yes }
			religion = death_god
		}
		else = { set_secret_religion = death_god }

		ai_chance = {
			factor = 50
			
			evil_ai_chance_score = yes
		}
	}
	
	option = {
		name = I_WILL_NOT_BETRAY_RELIGION
		
		piety = -100
		
		ai_chance = {
			factor = 0
		}
	}
}